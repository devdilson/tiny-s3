<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Browser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1442.0/aws-sdk.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
<!-- Login Form -->
<div id="loginForm" class="flex min-h-screen items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <div class="flex items-center justify-center mb-8">
            <i data-feather="database" class="w-12 h-12 text-blue-600"></i>
            <h1 class="text-2xl font-bold ml-2">S3 Browser</h1>
        </div>
        <form onsubmit="handleLogin(event)" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Endpoint</label>
                <input
                        type="text"
                        id="endpoint"
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
                        placeholder="http://localhost:8080"
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Access Key</label>
                <input
                        type="text"
                        id="accessKey"
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Secret Key</label>
                <input
                        type="password"
                        id="secretKey"
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
                >
            </div>
            <div id="loginError" class="text-red-500 text-sm hidden"></div>
            <button
                    type="submit"
                    class="w-full bg-blue-600 text-white rounded-md px-4 py-2 hover:bg-blue-700"
            >
                Connect
            </button>
        </form>
    </div>
</div>

<!-- Main Content -->
<div id="content" class="h-screen flex flex-col hidden">
    <!-- Header -->
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <i data-feather="database" class="w-6 h-6 text-blue-600"></i>
                <h1 class="ml-2 text-xl font-semibold">S3 Browser</h1>
            </div>
            <button
                    onclick="handleLogout()"
                    class="flex items-center text-gray-600 hover:text-gray-900"
            >
                <i data-feather="log-out" class="w-5 h-5 mr-1"></i>
                Logout
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 max-w-7xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow">
            <!-- Navigation Bar -->
            <div class="p-4 border-b flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <button
                            id="backButton"
                            onclick="navigateBack()"
                            class="flex items-center text-gray-600 hover:text-gray-900 hidden"
                    >
                        <i data-feather="chevron-left" class="w-5 h-5"></i>
                        Back
                    </button>
                    <span id="breadcrumb" class="text-gray-600">
                            /
                        </span>
                </div>
                <div class="flex space-x-2">
                    <button
                            id="newBucketButton"
                            onclick="toggleCreateBucketForm()"
                            class="flex items-center px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                        <i data-feather="folder-plus" class="w-4 h-4 mr-1"></i>
                        New Bucket
                    </button>
                    <input
                            type="file"
                            id="fileInput"
                            class="hidden"
                            onchange="handleFileUpload(event)"
                    >
                    <button
                            id="uploadButton"
                            onclick="document.getElementById('fileInput').click()"
                            class="flex items-center px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 hidden"
                    >
                        <i data-feather="upload" class="w-4 h-4 mr-1"></i>
                        Upload
                    </button>
                </div>
            </div>

            <!-- Create Bucket Form -->
            <div id="createBucketForm" class="p-4 bg-gray-50 border-b hidden">
                <div class="flex space-x-2">
                    <input
                            type="text"
                            id="newBucketName"
                            class="flex-1 rounded-md border border-gray-300 px-3 py-2"
                            placeholder="Enter bucket name"
                    >
                    <button
                            onclick="createBucket()"
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                        Create
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="p-8 text-center text-gray-600 hidden">
                Loading...
            </div>

            <!-- File List -->
            <div class="overflow-x-auto flex-1">
                <table class="w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Modified</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="fileList" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script>
    // Initialize Feather Icons
    document.addEventListener('DOMContentLoaded', () => {
        feather.replace();
    });

    let s3;
    let currentPath = [];

    // Check for saved credentials on load
    window.addEventListener('load', () => {
        const savedCredentials = localStorage.getItem('s3credentials');
        if (savedCredentials) {
            const creds = JSON.parse(savedCredentials);
            document.getElementById('endpoint').value = creds.endpoint;
            document.getElementById('accessKey').value = creds.accessKey;
            document.getElementById('secretKey').value = creds.secretKey;
            initializeS3(creds);
        }
    });

    function showError(message) {
        const errorElement = document.getElementById('loginError');
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');
    }

    function hideError() {
        const errorElement = document.getElementById('loginError');
        errorElement.classList.add('hidden');
    }

    function showLoading(show = true) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
        document.getElementById('fileList').style.display = show ? 'none' : 'table-row-group';
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(date) {
        return new Date(date).toLocaleString();
    }

    function handleLogin(event) {
        event.preventDefault();
        hideError();

        const credentials = {
            endpoint: document.getElementById('endpoint').value,
            accessKey: document.getElementById('accessKey').value,
            secretKey: document.getElementById('secretKey').value
        };

        initializeS3(credentials);
    }

    function initializeS3(credentials) {
        const { endpoint, accessKey, secretKey } = credentials;

        AWS.config.update({
            accessKeyId: accessKey,
            secretAccessKey: secretKey,
            endpoint: endpoint,
            s3ForcePathStyle: true,
            signatureVersion: 'v4',
            region: 'us-east-1'
        });

        s3 = new AWS.S3();

        // Test connection by listing buckets
        listBuckets()
            .then(() => {
                localStorage.setItem('s3credentials', JSON.stringify(credentials));
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('content').style.display = 'flex';
            })
            .catch(error => {
                showError('Connection failed: ' + error.message);
            });
    }

    function handleLogout() {
        localStorage.removeItem('s3credentials');
        location.reload();
    }

    function toggleCreateBucketForm() {
        const form = document.getElementById('createBucketForm');
        form.classList.toggle('hidden');
    }

    async function createBucket() {
        const bucketName = document.getElementById('newBucketName').value;
        if (!bucketName) return;

        try {
            showLoading();
            await s3.createBucket({ Bucket: bucketName }).promise();
            document.getElementById('createBucketForm').classList.add('hidden');
            document.getElementById('newBucketName').value = '';
            await listBuckets();
        } catch (error) {
            alert('Failed to create bucket: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function listBuckets() {
        try {
            showLoading();
            const data = await s3.listBuckets().promise();
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            data.Buckets.forEach(bucket => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i data-feather="database" class="w-5 h-5 text-gray-400 mr-2"></i>
                                <span class="text-sm text-gray-900">${bucket.Name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">-</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(bucket.CreationDate)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-2">
                                <button
                                    class="text-red-600 hover:text-red-900"
                                    onclick="deleteBucket('${bucket.Name}')"
                                >
                                    <i data-feather="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </td>
                    `;
                tr.onclick = (e) => {
                    if (!e.target.closest('button')) {
                        navigateToBucket(bucket.Name);
                    }
                };
                fileList.appendChild(tr);
            });

            feather.replace();
            currentPath = [];
            updateNavigation();
        } finally {
            showLoading(false);
        }
    }

    async function listObjects(bucket, prefix = '') {
        try {
            showLoading();
            const params = {
                Bucket: bucket,
                Prefix: prefix
            };

            const data = await s3.listObjects(params).promise();
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            data.Contents.forEach(object => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i data-feather="file" class="w-5 h-5 text-gray-400 mr-2"></i>
                                <span class="text-sm text-gray-900">${object.Key}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatBytes(object.Size)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(object.LastModified)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-2">
                                <button
                                    class="text-blue-600 hover:text-blue-900"
                                    onclick="downloadObject('${object.Key}')">
                                    <i data-feather="download" class="w-5 h-5"></i>
                                </button>
                                <button
                                    class="text-red-600 hover:text-red-900"
                                    onclick="deleteObject('${object.Key}')"
                                >
                                    <i data-feather="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </td>
                    `;
                fileList.appendChild(tr);
            });

            feather.replace();
            updateNavigation();
        } finally {
            showLoading(false);
        }
    }

    function updateNavigation() {
        const backButton = document.getElementById('backButton');
        const uploadButton = document.getElementById('uploadButton');
        const newBucketButton = document.getElementById('newBucketButton');
        const breadcrumb = document.getElementById('breadcrumb');

        // Update breadcrumb
        breadcrumb.textContent = '/ ' + currentPath.join(' / ');

        // Show/hide back button
        backButton.style.display = currentPath.length > 0 ? 'flex' : 'none';

        // Show/hide upload button
        uploadButton.style.display = currentPath.length > 0 ? 'flex' : 'none';

        // Show/hide new bucket button
        newBucketButton.style.display = currentPath.length === 0 ? 'flex' : 'none';
    }

    function navigateBack() {
        if (currentPath.length === 1) {
            listBuckets();
        } else {
            currentPath.pop();
            listObjects(currentPath[0], currentPath.slice(1).join('/'));
        }
    }

    function navigateToBucket(bucket) {
        currentPath = [bucket];
        listObjects(bucket);
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            showLoading();
            const bucket = currentPath[0];
            const key = currentPath.length > 1 ?
                currentPath.slice(1).join('/') + '/' + file.name :
                file.name;

            const params = {
                Bucket: bucket,
                Key: key,
                Body: file
            };

            await s3.upload(params).promise();
            listObjects(bucket, currentPath.slice(1).join('/'));
        } catch (error) {
            alert('Upload failed: ' + error.message);
        } finally {
            showLoading(false);
            event.target.value = ''; // Reset file input
        }
    }

    async function downloadObject(key) {
        try {
            showLoading();
            const params = {
                Bucket: currentPath[0],
                Key: key
            };

            const data = await s3.getObject(params).promise();
            const blob = new Blob([data.Body], { type: data.ContentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = key.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (error) {
            alert('Download failed: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function deleteObject(key) {
        if (!confirm('Are you sure you want to delete this object?')) return;

        try {
            showLoading();
            const params = {
                Bucket: currentPath[0],
                Key: key
            };

            await s3.deleteObject(params).promise();
            listObjects(currentPath[0], currentPath.slice(1).join('/'));
        } catch (error) {
            alert('Delete failed: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function deleteBucket(bucket) {
        if (!confirm('Are you sure you want to delete this bucket?')) return;

        try {
            showLoading();
            await s3.deleteBucket({ Bucket: bucket }).promise();
            listBuckets();
        } catch (error) {
            alert('Delete failed: ' + error.message);
        } finally {
            showLoading(false);
        }
    }
</script>
</body>
</html>